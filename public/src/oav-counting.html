<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymer-ts/polymer-ts.html">
<link rel="import" href="../bower_components/paper-map-info/paper-map-info.html">

<link rel="import" href="../bower_components/paper-material/paper-material.html">

<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-signals/iron-signals.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/app-localize-behavior/app-localize-behavior.html">

<link rel="import" href="oav-behaviors/app-helpers.html">
<link rel="import" href="oav-confirmed-passphrase-pair.html">

<dom-module id="oav-counting">
  <template>
    <style include="iron-flex iron-flex-alignment">


      paper-button {
        margin-top: 16px;
        background-color: #FFF;
        padding: 16px;
      }

      oav-confirmed-passphrase-pair {
        margin-top: 16px;
      }
    </style>

    <div class="layout vertical center-center">

      <div class="layout vertical center-center" hidden$="[[countInProgress]]">

        <oav-confirmed-passphrase-pair
                hide-character-help
                first-part-of-passphrase="{{firstPartOfPassphrase}}"
                second-part-of-passphrase="{{secondPartOfPassphrase}}"
                all-passphrases-validated="{{allPassphrasesValidated}}"
                minimum-passphrase-length="{{minimumPassphraseLength}}">
        </oav-confirmed-passphrase-pair>

        <div class="createButtonContainer" hidden$="[[!allPassphrasesValidated]]">
          <paper-button raised on-tap="_startCounting">{{localize('startCounting')}}</paper-button>
        </div>

      </div>

      <div class="layout vertical center-center">

      </div>

      <div class="layout horizontal center-center">
        <oav-ajax id="startCounting" method="POST" url="/counting/start_counting" on-response="_startCountingResponse"></oav-ajax>
        <oav-ajax id="countingProgress" method="GET" url="/counting/counting_progress" on-response="_progressReport"></oav-ajax>
      </div>
    </div>
  </template>

  <script>
    Polymer({
      is: 'oav-counting',

      behaviors: [
        Polymer.appHelpers,
        Polymer.AppLocalizeBehavior
      ],

      properties: {

        minimumPassphraseLength: {
          type: Number
        },

        firstPartOfPassphrase: {
          type: String
        },

        secondPartOfPassphrase: {
          type: String
        },

        allPassphrasesValidated: {
          type: Boolean
        },

        countInProgress: {
          type: Boolean,
          value: false
        }
      },

      _validatePassphrase: function (password) {
        return (password && password.length>=this.minimumPassphraseLength);
      },

      _passphraseValidated: function () {
        return (this._validatePassphrase(this.firstPartOfPassphrase) && this._validatePassphrase(this.secondPartOfPassphrase));
      },

      attached: function() {
        this.loadLanguage(this.resolveUrl('locales.json'));
      },

      _progressReport: function (event, detail) {
        debugger;
        var countingProgress = JSON.parse(detail.response);
        debugger;
        this._triggerCountingProgress();
      },

      _triggerCountingProgress: function () {
        this.async(function () {
          if (this.countInProgress) {
            this.$.countingProgress.generateRequest();
          }
        }, 1000);
      },

      _startCounting: function () {
        if (this._passphraseValidated()) {
          this.$.startCounting.body = { passphrase: this.firstPartOfPassphrase + this.secondPartOfPassphrase };
          this.$.startCounting.generateRequest();
          this.countInProgress = true;
        } else {
          this.fire('oav-passphrase-not-validated');
        }
      },

      _startCountingResponse: function (event, detail) {
        this._triggerCountingProgress();
      }
    });
  </script>
</dom-module>